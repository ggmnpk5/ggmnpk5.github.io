<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—°íƒœ-ì¹­ë‹¤ì˜¤ ì—¬í–‰ í”Œë˜ë„ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="importmap">
    {
      "imports": {
        "lucide-react": "https://esm.sh/lucide-react@0.263.1?external=react",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s ease-out forwards; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        @keyframes bounce-slight { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animate-bounce-slight { animation: bounce-slight 2s infinite ease-in-out; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { 
          Calendar, Clock, MapPin, Plus, Trash2, Languages, Coins, Sparkles, 
          ChevronRight, Plane, Utensils, Beer, Camera, Hotel, X, Save, 
          RefreshCw, Loader2, MessageCircle, Send, Bot, RotateCcw, ShoppingBag, 
          Users, CheckSquare, Check, Square, Filter, AlertTriangle 
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, serverTimestamp, orderBy, query } from 'firebase/firestore';

        // --- ì„¤ì • ì˜ì—­ (ìì‹ ì˜ í‚¤ë¡œ ë³€ê²½ í•„ìš”) ---
        // ì£¼ì˜: ì‹¤ì œ ë°°í¬ ì‹œ API í‚¤ê°€ ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”.
        const apiKey = "YOUR_GEMINI_API_KEY"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;

        // Firebase ì„¤ì • (ë³¸ì¸ì˜ Firebase ì½˜ì†”ì—ì„œ ê°€ì ¸ì˜¨ ì„¤ì •ê°’ìœ¼ë¡œ êµì²´í•´ì•¼ ì‘ë™í•©ë‹ˆë‹¤)
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // ì•± ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'travel-app-demo'; // ì„ì˜ì˜ ID

        // --- Mock Data & Helper Functions ---
        const DEFAULT_EXCHANGE_RATE = 192.5; 
        const TRAVEL_PHRASES = [
          { ko: "ì•ˆë…•í•˜ì„¸ìš”", cn: "ä½ å¥½", pinyin: "NÇ hÇo", pronunciation: "ë‹ˆí•˜ì˜¤" },
          { ko: "ê°ì‚¬í•©ë‹ˆë‹¤", cn: "è°¢è°¢", pinyin: "XiÃ¨xiÃ¨", pronunciation: "ì”¨ì—ì”¨ì—" },
          { ko: "ì–¼ë§ˆì¸ê°€ìš”?", cn: "å¤šå°‘é’±?", pinyin: "DuÅshÇo qiÃ¡n?", pronunciation: "ëšœì–´ìƒ¤ì˜¤ ì¹˜ì—”?" },
          { ko: "í™”ì¥ì‹¤ì´ ì–´ë””ì¸ê°€ìš”?", cn: "æ´—æ‰‹é—´åœ¨å“ªé‡Œ?", pinyin: "XÇshÇ’ujiÄn zÃ i nÇlÇ?", pronunciation: "ì‹œì‡¼ìš°ì§€ì—” ì§œì´ ë‚˜ë¦¬?" },
          { ko: "ê³ ìˆ˜ ë¹¼ì£¼ì„¸ìš”", cn: "ä¸è¦é¦™èœ", pinyin: "BÃ¹ yÃ o xiÄngcÃ i", pronunciation: "ë¶€ì•¼ì˜¤ ìƒ¹ì°¨ì´" },
          { ko: "ì´ê±° ì£¼ì„¸ìš”", cn: "æˆ‘è¦è¿™ä¸ª", pinyin: "WÇ’ yÃ o zhÃ¨ge", pronunciation: "ì›Œì•¼ì˜¤ ì©Œê±°" },
          { ko: "ê³„ì‚°ì„œ ì£¼ì„¸ìš”", cn: "ä¹°å•", pinyin: "MÇidÄn", pronunciation: "ë§ˆì´ë‹¨" },
        ];

        const CATEGORIES = {
          sightseeing: { label: 'ê´€ê´‘', icon: Camera, color: 'text-purple-600 bg-purple-50 border-purple-100' },
          food: { label: 'ì‹ë‹¹/ì¹´í˜', icon: Utensils, color: 'text-orange-600 bg-orange-50 border-orange-100' },
          shopping: { label: 'ì‡¼í•‘', icon: ShoppingBag, color: 'text-pink-600 bg-pink-50 border-pink-100' },
          accommodation: { label: 'ìˆ™ì†Œ', icon: Hotel, color: 'text-indigo-600 bg-indigo-50 border-indigo-100' },
          transport: { label: 'ì´ë™', icon: Plane, color: 'text-blue-600 bg-blue-50 border-blue-100' },
          etc: { label: 'ê¸°íƒ€', icon: MapPin, color: 'text-gray-600 bg-gray-50 border-gray-100' }
        };

        const CHECKLIST_TYPES = {
          food: { label: 'ë¨¹í‚·ë¦¬ìŠ¤íŠ¸', icon: Utensils, color: 'bg-orange-100 text-orange-600' },
          shopping: { label: 'ì‡¼í•‘ë¦¬ìŠ¤íŠ¸', icon: ShoppingBag, color: 'bg-pink-100 text-pink-600' },
          sightseeing: { label: 'ê´€ê´‘ëª…ì†Œ', icon: Camera, color: 'bg-purple-100 text-purple-600' },
          etc: { label: 'ê¸°íƒ€/ì¤€ë¹„ë¬¼', icon: CheckSquare, color: 'bg-gray-100 text-gray-600' }
        };

        // --- Components ---
        const Navigation = ({ activeTab, setActiveTab }) => (
          <div className="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 flex justify-around py-3 pb-6 z-50 shadow-lg text-xs font-medium">
            <button onClick={() => setActiveTab('timeline')} className={`flex flex-col items-center space-y-1 ${activeTab === 'timeline' ? 'text-teal-600' : 'text-gray-400'}`}>
              <Calendar size={22} /> <span>ì¼ì •</span>
            </button>
            <button onClick={() => setActiveTab('checklist')} className={`flex flex-col items-center space-y-1 ${activeTab === 'checklist' ? 'text-teal-600' : 'text-gray-400'}`}>
              <CheckSquare size={22} /> <span>ì²´í¬ë¦¬ìŠ¤íŠ¸</span>
            </button>
            <button onClick={() => setActiveTab('translate')} className={`flex flex-col items-center space-y-1 ${activeTab === 'translate' ? 'text-teal-600' : 'text-gray-400'}`}>
              <Languages size={22} /> <span>í†µì—­</span>
            </button>
            <button onClick={() => setActiveTab('currency')} className={`flex flex-col items-center space-y-1 ${activeTab === 'currency' ? 'text-teal-600' : 'text-gray-400'}`}>
              <Coins size={22} /> <span>í™˜ìœ¨</span>
            </button>
          </div>
        );

        const TimelineItem = ({ item, onDelete }) => {
          const categoryConfig = CATEGORIES[item.category] || CATEGORIES.etc;
          const CategoryIcon = categoryConfig.icon;
          return (
            <div className="mb-6 ml-4 relative border-l-2 border-teal-200 pl-6 pb-2 last:border-l-0 last:mb-0 animate-fade-in">
              <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-teal-500 border-4 border-white shadow-sm"></div>
              <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                <div className="flex justify-between items-start mb-2">
                  <div className="flex items-center space-x-2">
                    <div className="flex items-center text-teal-700 font-bold text-lg">
                      <Clock size={16} className="mr-1" /> <span>{item.time}</span>
                    </div>
                    <div className={`flex items-center px-2 py-1 rounded-md border text-xs font-bold ${categoryConfig.color}`}>
                      <CategoryIcon size={12} className="mr-1" /> {categoryConfig.label}
                    </div>
                  </div>
                  <button onClick={() => onDelete(item.id)} className="text-gray-300 hover:text-red-500 transition-colors"><Trash2 size={16} /></button>
                </div>
                <h3 className="text-xl font-bold text-gray-800 mb-1">{item.title}</h3>
                <div className="flex items-center text-gray-500 text-sm"><MapPin size={14} className="mr-1" />{item.location}</div>
                {item.note && <div className="text-gray-600 text-sm mt-3 bg-gray-50 p-2 rounded">{item.note}</div>}
              </div>
            </div>
          );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, message }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black bg-opacity-50 animate-fade-in">
              <div className="bg-white rounded-2xl p-6 w-80 shadow-2xl">
                <div className="flex items-center justify-center mb-4 text-red-500"><AlertTriangle size={40} /></div>
                <h3 className="text-lg font-bold text-gray-800 text-center mb-2">ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
                <p className="text-gray-600 text-sm text-center mb-6">{message}</p>
                <div className="flex space-x-3">
                  <button onClick={onClose} className="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition-colors">ì·¨ì†Œ</button>
                  <button onClick={onConfirm} className="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition-colors">ì‚­ì œ</button>
                </div>
              </div>
            </div>
          );
        };

        const AIChatModal = ({ isOpen, onClose }) => {
          const initialMessage = { role: 'model', text: "ì•ˆë…•í•˜ì„¸ìš”! ì—°íƒœ-ì¹­ë‹¤ì˜¤ ì—¬í–‰ ê°€ì´ë“œì…ë‹ˆë‹¤. ë§›ì§‘, êµí†µ, ì¼ì • ë“± ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”! ğŸ‡¨ğŸ‡³" };
          const [messages, setMessages] = useState([initialMessage]);
          const [input, setInput] = useState('');
          const [isLoading, setIsLoading] = useState(false);
          const messagesEndRef = useRef(null);

          const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
          useEffect(() => { if (isOpen) scrollToBottom(); }, [messages, isOpen]);

          const handleReset = () => setMessages([initialMessage]);
          const handleSend = async () => {
            if (!input.trim()) return;
            const userMessage = { role: 'user', text: input };
            setMessages(prev => [...prev, userMessage]);
            setInput('');
            setIsLoading(true);
            try {
              const prompt = `You are a friendly travel guide for Yantai and Qingdao. User: ${input}`;
              // ì‹¤ì œ API í˜¸ì¶œì€ í‚¤ê°€ ì—†ìœ¼ë©´ ì‹¤íŒ¨í•©ë‹ˆë‹¤.
              // const response = await fetch(API_URL, ...);
              // Mock Response
              setTimeout(() => {
                  setMessages(prev => [...prev, { role: 'model', text: "API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°ëª¨ ì‘ë‹µì„ ë³´ëƒ…ë‹ˆë‹¤. (HTML ì½”ë“œ ë‚´ apiKey ë³€ìˆ˜ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.)" }]);
                  setIsLoading(false);
              }, 1000);
            } catch (error) {
              setMessages(prev => [...prev, { role: 'model', text: "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." }]);
              setIsLoading(false);
            }
          };
          
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 z-[60] flex flex-col bg-white animate-slide-up">
              <div className="bg-teal-600 text-white p-4 flex justify-between items-center shadow-md">
                <div className="flex items-center"><Bot className="mr-2" size={24} /><div><h2 className="font-bold text-lg">AI ì—¬í–‰ ê°€ì´ë“œ</h2><p className="text-xs text-teal-100">ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”</p></div></div>
                <div className="flex items-center space-x-1">
                  <button onClick={handleReset} className="p-2 hover:bg-teal-700 rounded-full"><RotateCcw size={20} /></button>
                  <button onClick={onClose} className="p-2 hover:bg-teal-700 rounded-full"><X size={24} /></button>
                </div>
              </div>
              <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                {messages.map((msg, idx) => (
                  <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[80%] p-3 rounded-2xl text-sm shadow-sm ${msg.role === 'user' ? 'bg-teal-600 text-white rounded-tr-none' : 'bg-white text-gray-800 border border-gray-200 rounded-tl-none'}`}>{msg.text}</div>
                  </div>
                ))}
                {isLoading && <div className="flex justify-start"><div className="bg-white p-3 rounded-2xl rounded-tl-none border border-gray-200 shadow-sm flex items-center space-x-2"><Loader2 size={16} className="animate-spin text-teal-600" /><span className="text-xs text-gray-500">ì‘ì„± ì¤‘...</span></div></div>}
                <div ref={messagesEndRef} />
              </div>
              <div className="p-4 bg-white border-t border-gray-200 pb-8">
                <div className="flex items-center space-x-2">
                  <input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSend()} placeholder="ì˜ˆ: ì¹­ë‹¤ì˜¤ ë§›ì§‘ ì¶”ì²œí•´ì¤˜" className="flex-1 p-3 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm" />
                  <button onClick={handleSend} disabled={isLoading || !input.trim()} className="p-3 bg-teal-600 text-white rounded-full hover:bg-teal-700 disabled:bg-gray-300 transition-colors shadow-md"><Send size={20} /></button>
                </div>
              </div>
            </div>
          );
        };

        const AddItemModal = ({ isOpen, onClose, onAdd, selectedDay }) => {
          const [title, setTitle] = useState('');
          const [time, setTime] = useState('');
          const [location, setLocation] = useState('');
          const [note, setNote] = useState('');
          const [category, setCategory] = useState('sightseeing');
          const [isSubmitting, setIsSubmitting] = useState(false);

          if (!isOpen) return null;
          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!title || !time || isSubmitting) return;
            setIsSubmitting(true);
            await onAdd({ day: selectedDay, time, title, location, note, category });
            setIsSubmitting(false);
            setTitle(''); setTime(''); setLocation(''); setNote(''); setCategory('sightseeing');
            onClose();
          };

          return (
            <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black bg-opacity-50">
              <div className="bg-white w-full sm:max-w-sm rounded-t-2xl sm:rounded-2xl shadow-2xl animate-slide-up flex flex-col max-h-[90vh]">
                <div className="p-6 pb-2 flex justify-between items-center border-b border-gray-100">
                  <h2 className="text-xl font-bold text-gray-800">{selectedDay}ì¼ì°¨ ì¼ì • ì¶”ê°€</h2>
                  <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={24} /></button>
                </div>
                <div className="overflow-y-auto p-6 pt-4 pb-24">
                  <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-600 mb-2">ì¢…ë¥˜</label>
                      <div className="grid grid-cols-3 gap-2">
                        {Object.entries(CATEGORIES).map(([key, config]) => {
                          const Icon = config.icon;
                          return (
                            <button key={key} type="button" onClick={() => setCategory(key)} className={`flex flex-col items-center justify-center p-2 rounded-xl border transition-all ${category === key ? 'bg-teal-50 border-teal-500 text-teal-700 ring-1 ring-teal-500' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}`}>
                              <Icon size={20} className="mb-1" /><span className="text-xs font-medium">{config.label}</span>
                            </button>
                          );
                        })}
                      </div>
                    </div>
                    <div><label className="block text-sm font-medium text-gray-600 mb-1">ì‹œê°„</label><input type="time" value={time} onChange={(e) => setTime(e.target.value)} className="w-full p-3 bg-gray-50 rounded-lg border border-gray-200" required /></div>
                    <div><label className="block text-sm font-medium text-gray-600 mb-1">ì¥ì†Œ/í™œë™ëª…</label><input type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="ì¹­ë‹¤ì˜¤ ë§¥ì£¼ ë°•ë¬¼ê´€" className="w-full p-3 bg-gray-50 rounded-lg border border-gray-200" required /></div>
                    <div><label className="block text-sm font-medium text-gray-600 mb-1">ìœ„ì¹˜</label><input type="text" value={location} onChange={(e) => setLocation(e.target.value)} className="w-full p-3 bg-gray-50 rounded-lg border border-gray-200" /></div>
                    <div><label className="block text-sm font-medium text-gray-600 mb-1">ë©”ëª¨</label><textarea value={note} onChange={(e) => setNote(e.target.value)} className="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 h-24 resize-none" /></div>
                    <button type="submit" disabled={isSubmitting} className="w-full bg-teal-600 text-white py-3 rounded-xl font-bold hover:bg-teal-700 flex items-center justify-center disabled:bg-gray-400">{isSubmitting ? <Loader2 className="animate-spin mr-2" size={18}/> : <Plus size={18} className="mr-2" />} ì¼ì • ì¶”ê°€í•˜ê¸°</button>
                  </form>
                </div>
              </div>
            </div>
          );
        };

        // --- Main App ---
        const TripPlannerApp = () => {
          const [activeTab, setActiveTab] = useState('timeline');
          const [activeDay, setActiveDay] = useState(1);
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [isChatOpen, setIsChatOpen] = useState(false);
          const [user, setUser] = useState(null);
          const [deleteState, setDeleteState] = useState({ isOpen: false, type: null, id: null });
          const [exchangeRate, setExchangeRate] = useState(DEFAULT_EXCHANGE_RATE);
          const [cnyAmount, setCnyAmount] = useState('');
          const [krwAmount, setKrwAmount] = useState('');
          const [itinerary, setItinerary] = useState([]);
          const [isLoadingData, setIsLoadingData] = useState(true);
          const [checklistItems, setChecklistItems] = useState([]);
          const [checklistInput, setChecklistInput] = useState('');
          const [checklistCategory, setChecklistCategory] = useState('food');
          const [checklistFilter, setChecklistFilter] = useState('all');
          const [transInput, setTransInput] = useState('');
          const [transResult, setTransResult] = useState({ cn: '', pinyin: '' });
          const [isTranslating, setIsTranslating] = useState(false);

          useEffect(() => {
            signInAnonymously(auth).catch((error) => console.error("Auth Error", error));
            const unsubscribe = onAuthStateChanged(auth, (currentUser) => setUser(currentUser));
            return () => unsubscribe();
          }, []);

          useEffect(() => {
            if (!user) return;
            // Firestore Listener (ì‹¤íŒ¨ì‹œ ë¡œì»¬ ìƒíƒœ ì²˜ë¦¬ë¥¼ ìœ„í•´ try-catch)
            try {
              const qItinerary = collection(db, 'artifacts', appId, 'public', 'data', 'itinerary');
              const unsubItinerary = onSnapshot(qItinerary, (snapshot) => {
                const loadedItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setItinerary(loadedItems);
                setIsLoadingData(false);
              }, (err) => { 
                  console.warn("Firestore sync failed (No keys):", err); 
                  setIsLoadingData(false); // Stop loading spinner
              });

              const qChecklist = query(collection(db, 'artifacts', appId, 'public', 'data', 'checklist'), orderBy('createdAt', 'desc'));
              const unsubChecklist = onSnapshot(qChecklist, (snapshot) => {
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setChecklistItems(items);
              }, (err) => console.warn("Firestore sync failed (No keys)"));
              
              return () => { unsubItinerary(); unsubChecklist(); };
            } catch (e) {
                console.error("Firebase Setup Error", e);
                setIsLoadingData(false);
            }
          }, [user]);

          // --- Handlers (Mocked if Firestore fails) ---
          const handleAddItem = async (newItem) => {
            const item = { ...newItem, category: newItem.category || 'etc', createdAt: new Date(), id: Date.now().toString() }; // Fallback ID
            try {
               if(user) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'itinerary'), item);
            } catch (e) {
               setItinerary(prev => [...prev, item]); // Local fallback
            }
          };

          const requestDeleteItem = (id) => setDeleteState({ isOpen: true, type: 'itinerary', id });
          
          const handleAddChecklistItem = async (e) => {
            e.preventDefault();
            if (!checklistInput.trim()) return;
            const newItem = { text: checklistInput, category: checklistCategory, isCompleted: false, createdAt: new Date(), id: Date.now().toString() };
            try {
              if(user) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'checklist'), newItem);
              else setChecklistItems(prev => [newItem, ...prev]);
            } catch(e) { setChecklistItems(prev => [newItem, ...prev]); }
            setChecklistInput('');
          };

          const handleToggleChecklistItem = async (id, currentStatus) => {
             // Local UI Update first for speed
             setChecklistItems(prev => prev.map(item => item.id === id ? {...item, isCompleted: !currentStatus} : item));
             try {
               if(user) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'checklist', id), { isCompleted: !currentStatus });
             } catch(e) {}
          };

          const requestDeleteChecklist = (id) => setDeleteState({ isOpen: true, type: 'checklist', id });

          const executeDelete = async () => {
            const { type, id } = deleteState;
            if(type === 'itinerary') setItinerary(prev => prev.filter(i => i.id !== id));
            else setChecklistItems(prev => prev.filter(i => i.id !== id));
            
            try {
              if(user && id) {
                const col = type === 'itinerary' ? 'itinerary' : 'checklist';
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
              }
            } catch(e) {}
            setDeleteState({ isOpen: false, type: null, id: null });
          };

          const handleCnyChange = (e) => { const val = e.target.value; setCnyAmount(val); setKrwAmount((parseFloat(val || 0) * exchangeRate).toFixed(0)); };
          const handleKrwChange = (e) => { const val = e.target.value; setKrwAmount(val); setCnyAmount((parseFloat(val || 0) / exchangeRate).toFixed(2)); };
          
          const handleTranslate = async () => {
             if (!transInput) return;
             setIsTranslating(true);
             // Demo Mock
             setTimeout(() => {
                 setTransResult({ cn: "API í‚¤ í•„ìš”", pinyin: "Check Code" });
                 setIsTranslating(false);
             }, 1000);
          };

          const currentDayItems = useMemo(() => itinerary.filter(item => item.day === activeDay).sort((a, b) => a.time.localeCompare(b.time)), [itinerary, activeDay]);
          const filteredChecklist = useMemo(() => checklistFilter === 'all' ? checklistItems : checklistItems.filter(item => (item.category || 'etc') === checklistFilter), [checklistItems, checklistFilter]);

          return (
            <div className="min-h-screen bg-gray-50 font-sans text-gray-800 pb-24">
              <div className="bg-teal-600 text-white p-6 rounded-b-3xl shadow-lg relative overflow-hidden">
                <div className="absolute top-0 right-0 opacity-10 transform translate-x-4 -translate-y-4"><Plane size={120} /></div>
                <h1 className="text-2xl font-bold mb-1 flex items-center">ì—°íƒœ-ì¹­ë‹¤ì˜¤ ì—¬í–‰ <span className="text-sm font-normal ml-2 bg-teal-700 px-2 py-1 rounded-full">5ë°• 6ì¼</span></h1>
                <div className="flex justify-between items-end"><p className="text-teal-100 text-sm opacity-90">Yantai & Qingdao Trip Planner</p></div>
              </div>

              <div className="max-w-md mx-auto p-4">
                {activeTab === 'timeline' && (
                  <>
                    <div className="flex overflow-x-auto pb-4 mb-2 hide-scrollbar space-x-3">
                      {[1, 2, 3, 4, 5, 6].map(day => (
                        <button key={day} onClick={() => setActiveDay(day)} className={`flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center transition-all duration-200 border ${activeDay === day ? 'bg-teal-600 text-white border-teal-600 shadow-md scale-105' : 'bg-white text-gray-400 border-gray-200 hover:border-teal-300'}`}>
                          <span className="text-xs font-medium mb-1">DAY</span><span className="text-2xl font-bold">{day}</span>
                        </button>
                      ))}
                    </div>
                    <div className="space-y-2 relative">
                      <div className="flex justify-between items-center mb-4 px-1">
                        <h2 className="text-lg font-bold text-gray-700">{activeDay}ì¼ì°¨ ì¼ì •</h2>
                        <button onClick={() => setIsModalOpen(true)} className="flex items-center text-teal-600 text-sm font-bold bg-teal-50 px-3 py-1.5 rounded-full hover:bg-teal-100 transition-colors"><Plus size={16} className="mr-1" />ì¶”ê°€</button>
                      </div>
                      {isLoadingData ? <div className="text-center py-12"><Loader2 className="animate-spin mx-auto text-teal-600" size={32} /><p className="text-gray-400 mt-2 text-sm">ì¼ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div> : 
                       currentDayItems.length === 0 ? <div className="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300"><p className="text-gray-400 mb-2">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p></div> : 
                       <div className="pl-2">{currentDayItems.map(item => <TimelineItem key={item.id} item={item} onDelete={requestDeleteItem} />)}</div>
                      }
                      <button onClick={() => setIsChatOpen(true)} className="fixed bottom-24 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-xl flex items-center justify-center hover:bg-indigo-700 z-40 animate-bounce-slight"><MessageCircle size={28} /></button>
                    </div>
                  </>
                )}

                {activeTab === 'checklist' && (
                   <div className="space-y-6 animate-fade-in">
                     <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                       <h2 className="text-lg font-bold mb-4 text-gray-800 flex items-center"><CheckSquare size={20} className="mr-2 text-teal-600" />ìœ„ì‹œë¦¬ìŠ¤íŠ¸ & ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
                       <form onSubmit={handleAddChecklistItem} className="space-y-3">
                         <div className="flex space-x-2 overflow-x-auto pb-2 hide-scrollbar">
                           {Object.entries(CHECKLIST_TYPES).map(([key, config]) => (
                             <button key={key} type="button" onClick={() => setChecklistCategory(key)} className={`flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-bold flex items-center transition-colors ${checklistCategory === key ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                               {checklistCategory === key && <Check size={12} className="mr-1" />}{config.label}
                             </button>
                           ))}
                         </div>
                         <div className="flex space-x-2"><input type="text" value={checklistInput} onChange={(e) => setChecklistInput(e.target.value)} placeholder="í•­ëª© ì…ë ¥" className="flex-1 p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm" /><button type="submit" disabled={!checklistInput.trim()} className="bg-teal-600 text-white p-3 rounded-xl hover:bg-teal-700 disabled:bg-gray-300"><Plus size={20} /></button></div>
                       </form>
                     </div>
                     <div className="flex space-x-2 overflow-x-auto pb-1 hide-scrollbar">
                        <button onClick={() => setChecklistFilter('all')} className={`px-4 py-2 rounded-full text-sm font-bold transition-colors whitespace-nowrap ${checklistFilter === 'all' ? 'bg-gray-800 text-white shadow-md' : 'bg-white border border-gray-200 text-gray-500'}`}>ì „ì²´ ë³´ê¸°</button>
                        {Object.entries(CHECKLIST_TYPES).map(([key, config]) => (
                          <button key={key} onClick={() => setChecklistFilter(key)} className={`px-4 py-2 rounded-full text-sm font-bold transition-colors whitespace-nowrap flex items-center ${checklistFilter === key ? 'bg-teal-600 text-white shadow-md' : 'bg-white border border-gray-200 text-gray-500'}`}><config.icon size={14} className="mr-1.5" />{config.label}</button>
                        ))}
                     </div>
                     <div className="space-y-3 min-h-[200px]">
                        {filteredChecklist.length === 0 ? <div className="text-center py-12 bg-white rounded-xl border border-dashed border-gray-200"><Filter size={32} className="mx-auto text-gray-300 mb-2" /><p className="text-gray-400 text-sm">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p></div> :
                         filteredChecklist.map(item => {
                           const config = CHECKLIST_TYPES[item.category] || CHECKLIST_TYPES.etc;
                           return (
                             <div key={item.id} className={`bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center transition-all animate-fade-in ${item.isCompleted ? 'opacity-60 bg-gray-50' : ''}`}>
                               <button onClick={() => handleToggleChecklistItem(item.id, item.isCompleted)} className={`mr-3 p-1 rounded-md transition-colors ${item.isCompleted ? 'text-teal-500 bg-teal-50' : 'text-gray-300 hover:text-teal-500'}`}>{item.isCompleted ? <CheckSquare size={24} /> : <Square size={24} />}</button>
                               <div className="flex-1"><div className="flex items-center mb-1"><span className={`text-[10px] px-2 py-0.5 rounded-full font-bold mr-2 ${config.color}`}>{config.label}</span></div><div className={`text-gray-800 font-medium ${item.isCompleted ? 'line-through text-gray-500' : ''}`}>{item.text}</div></div>
                               <button onClick={() => requestDeleteChecklist(item.id)} className="ml-2 text-gray-300 hover:text-red-500 p-2"><Trash2 size={16} /></button>
                             </div>
                           );
                         })
                        }
                     </div>
                   </div>
                )}

                {activeTab === 'translate' && (
                  <div className="space-y-6 animate-fade-in">
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                      <h2 className="text-lg font-bold mb-4 flex items-center text-gray-800"><Languages size={20} className="mr-2 text-teal-600" />í•„ìˆ˜ íšŒí™” ì¹´ë“œ</h2>
                      <div className="grid grid-cols-1 gap-3">
                        {TRAVEL_PHRASES.map((phrase, idx) => (
                          <div key={idx} className="p-3 border rounded-xl hover:bg-teal-50 transition-colors cursor-pointer group">
                            <div className="flex justify-between items-start"><span className="font-bold text-gray-700">{phrase.ko}</span><button onClick={() => navigator.clipboard.writeText(phrase.cn)}><Utensils size={14} className="opacity-0" /></button></div>
                            <div className="flex items-baseline mt-1 space-x-2"><span className="text-lg text-teal-700 font-bold">{phrase.cn}</span><span className="text-sm text-teal-500 font-medium">{phrase.pinyin}</span></div>
                            <div className="text-xs text-gray-400 mt-1 bg-gray-100 inline-block px-2 py-0.5 rounded-full">{phrase.pronunciation}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                      <h2 className="text-lg font-bold mb-3 text-gray-800 flex items-center"><Sparkles size={18} className="mr-2 text-purple-500" />AI ì‹¤ì‹œê°„ í†µì—­</h2>
                      <textarea className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl mb-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500" rows="3" placeholder="í•œêµ­ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." value={transInput} onChange={(e) => setTransInput(e.target.value)} />
                      <button onClick={handleTranslate} disabled={isTranslating} className="w-full bg-gray-800 text-white py-2.5 rounded-xl font-bold text-sm mb-3 hover:bg-gray-900 disabled:bg-gray-400 flex justify-center items-center">{isTranslating ? "ë²ˆì—­ ì¤‘..." : "ì¤‘êµ­ì–´ë¡œ ë²ˆì—­í•˜ê¸°"}</button>
                      {transResult.cn && <div className="p-4 bg-teal-50 rounded-xl border border-teal-100"><div className="text-2xl text-teal-800 font-bold mb-1">{transResult.cn}</div><div className="text-md text-teal-600 font-medium">{transResult.pinyin}</div></div>}
                    </div>
                  </div>
                )}

                {activeTab === 'currency' && (
                  <div className="space-y-6 animate-fade-in">
                    <div className="bg-gradient-to-br from-teal-500 to-teal-600 p-6 rounded-2xl shadow-lg text-white">
                      <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold flex items-center"><Coins size={24} className="mr-2" />í™˜ìœ¨ ê³„ì‚°ê¸°</h2><div className="bg-teal-700 bg-opacity-50 px-3 py-1 rounded-full text-xs flex items-center"><RefreshCw size={12} className="mr-1" />1 CNY = {exchangeRate} KRW</div></div>
                      <div className="space-y-4">
                        <div className="relative"><label className="text-teal-100 text-xs font-medium ml-1 block mb-1">ì¤‘êµ­ ìœ„ì•ˆ (CNY)</label><input type="number" value={cnyAmount} onChange={handleCnyChange} className="w-full p-4 pr-12 rounded-xl bg-white text-gray-800 text-2xl font-bold focus:outline-none shadow-inner" placeholder="0" /><span className="absolute right-4 top-9 text-gray-400 font-bold">Â¥</span></div>
                        <div className="flex justify-center"><div className="bg-white bg-opacity-20 p-1 rounded-full"><ChevronRight className="transform rotate-90 text-white" /></div></div>
                        <div className="relative"><label className="text-teal-100 text-xs font-medium ml-1 block mb-1">í•œêµ­ ì› (KRW)</label><input type="number" value={krwAmount} onChange={handleKrwChange} className="w-full p-4 pr-12 rounded-xl bg-white text-gray-800 text-2xl font-bold focus:outline-none shadow-inner" placeholder="0" /><span className="absolute right-4 top-9 text-gray-400 font-bold">â‚©</span></div>
                      </div>
                    </div>
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                       <h3 className="font-bold text-gray-700 mb-3 text-sm">í™˜ìœ¨ ì„¤ì •</h3>
                       <div className="flex items-center space-x-2"><span className="text-sm text-gray-500">1 ìœ„ì•ˆ =</span><input type="number" value={exchangeRate} onChange={(e) => setExchangeRate(e.target.value)} className="w-24 p-2 border border-gray-200 rounded-lg text-center font-bold text-gray-700" /><span className="text-sm text-gray-500">ì›</span><button className="ml-auto bg-gray-100 p-2 rounded-lg text-gray-500 hover:bg-gray-200"><Save size={16} /></button></div>
                    </div>
                  </div>
                )}
              </div>

              <AddItemModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onAdd={handleAddItem} selectedDay={activeDay} />
              <AIChatModal isOpen={isChatOpen} onClose={() => setIsChatOpen(false)} />
              <ConfirmModal isOpen={deleteState.isOpen} onClose={() => setDeleteState({ isOpen: false, type: null, id: null })} onConfirm={executeDelete} message={deleteState.type === 'itinerary' ? "ì´ ì¼ì •ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ì´ í•­ëª©ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"} />
              <Navigation activeTab={activeTab} setActiveTab={setActiveTab} />
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TripPlannerApp />);
    </script>
</body>
</html>
